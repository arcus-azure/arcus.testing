name: Inclusive Language Check

on:
  pull_request:
    paths:
      - 'docs/preview/**'
      - 'docs/versioned_docs/**'
  push:
    paths:
      - 'docs/preview/**'
      - 'docs/versioned_docs/**'

jobs:
  check-inclusive-language:
    name: Check inclusive language in Markdown files
    runs-on: windows-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run inclusive language check
        id: check
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $FileWildCard = "*.md?"
          $json = Invoke-RestMethod -Method GET https://inclusivenaming.org/word-lists/index.json

          $paths = @("docs/preview", "docs/versioned_docs")
          $files = @()
          foreach ($path in $paths) {
            if (Test-Path $path) {
              $files += Get-ChildItem $path -Recurse -Filter $FileWildCard
            }
          }

          $violations = @()
          foreach ($file in $files) {
            $content = Get-Content -Raw $file.FullName
            foreach ($check in $json.data) {
              if ($content -match [regex]::Escape($check.term)) {
                $violations += @{
                  file = $file.FullName
                  term = $check.term
                  recommendation = $check.recommendation
                  replacements = ($check.recommended_replacements -join ', ')
                  tier = $check.tier
                  page = $check.term_page
                }
              }
            }
          }

          if ($violations.Count -gt 0) {
            $body = "### ⚠️ Inclusive Language Violations Detected`n"
            foreach ($v in $violations) {
              $body += "`n- **File:** $($v.file)`n  - Term: **$($v.term)**`n  - Recommendation: $($v.recommendation)`n  - Replacements: $($v.replacements)`n  - [More info]($($v.page))`n"
            }

            # save the markdown to an output file
            $body | Out-File -FilePath violations.md -Encoding utf8

            # expose to next step
            echo "found=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "found=false" >> $env:GITHUB_OUTPUT
          }

      - name: Comment on PR if violations found
        if: steps.check.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: inclusive-language-check
          path: violations.md

      - name: Fail if violations found
        if: steps.check.outputs.found == 'true'
        run: |
          Write-Error "❌ Inclusive language violations found. See PR comment for details."
          exit 1
