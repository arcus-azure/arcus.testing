name: $(date:yyyyMMdd)$(rev:.r)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*

pr:
  paths:
    include:
      - src/*
      - build/*

parameters:
  - name: 'Package.Version.ManualTrigger'
    type: string
    default: 'preview'
  - name: azureServiceConnection
    displayName: 'Azure service connection'
    type: string
    default: 'Azure Codit-Arcus Service Principal'

resources:
  repositories:
    - repository: templates
      type: github
      name: arcus-azure/azure-devops-templates
      endpoint: arcus-azure

variables:
  - group: 'GitHub Configuration'
  - group: 'Build Configuration'
  - group: 'MyGet'
  - template: ./variables/build.yml
  - template: ./variables/test.yml

stages:
  - stage: Build
    jobs:
      - job: Compile
        pool:
          vmImage: '$(Vm.Image)'
        steps:
          - template: 'nuget/determine-pr-version.yml@templates'
            parameters:
              manualTriggerVersion: ${{ parameters['Package.Version.ManualTrigger'] }}
          - task: UseDotNet@2
            displayName: 'Import .NET SDK ($(DotNet.Sdk.VersionBC))'
            inputs:
              packageType: 'sdk'
              version: '$(DotNet.Sdk.VersionBC)'
          - task: UseDotNet@2
            displayName: 'Import .NET SDK ($(DotNet.Sdk.Version))'
            inputs:
              packageType: 'sdk'
              version: '$(DotNet.Sdk.Version)'
              includePreviewVersions: true
          - task: DotNetCoreCLI@2
            displayName: 'Publish Build Output'
            inputs:
              command: 'build'
              publishWebProjects: false
              projects: '**/*.sln'
              arguments: '--configuration $(Build.Configuration) --framework net10.0 --version-suffix $(packageVersion)'
              zipAfterPublish: false
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(Pipeline.Workspace)/src/*'
              artifact: Build

  - stage: Tests
    dependsOn: Build
    condition: succeeded()
    jobs:
      - template: templates/unit-tests.yml
      # - template: templates/integration-tests.yml
      #   parameters:
      #     azureServiceConnection: '${{ parameters.azureServiceConnection }}'
      - template: templates/publish-coverage.yml

  - stage: Release
    dependsOn: Tests
    condition: succeeded()
    jobs:
      - job: PushToMyGet
        displayName: 'Push to MyGet'
        pool:
          vmImage: '$(Vm.Image)'
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download build artifacts'
            inputs:
              artifact: 'Build'
              path: '$(Build.SourcesDirectory)'
          - task: DotNetCoreCLI@2
            displayName: 'Push to MyGet.org'
            inputs:
              command: 'custom'
              custom: 'nuget'
              arguments: 'push src/**/*.nupkg --skip-duplicate --source $(MyGet.SourceUrl) --api-key $(MyGet.ApiKey)'
