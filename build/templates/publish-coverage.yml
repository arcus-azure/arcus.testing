jobs:
  - job: PublishCoverage
    displayName: 'Publish code coverage'
    pool:
      vmImage: '$(Vm.Image)'
    dependsOn:
      - UnitTests
      - IntegrationTests
    steps:
      - task: DownloadPipelineArtifact@2
        displayName: 'Download coverage unit artifacts'
        inputs:
          artifact: 'Coverage-Unit'
          path: '$(Build.SourcesDirectory)/coverage-unit'

      - task: DownloadPipelineArtifact@2
        displayName: 'Download coverage integration artifacts'
        inputs:
          artifact: 'Coverage-Integration'
          path: '$(Build.SourcesDirectory)/coverage-integration'

      - task: PublishCodeCoverageResults@2
        displayName: 'Publish code coverage report'
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'src/**/coverage.cobertura.xml'
          failIfCoverageEmpty: true