parameters:
  azureServiceConnection: ''

jobs:
  - job: InfraTests
    displayName: 'Run infrastructure tests'
    pool:
      vmImage: $(Vm.Image)
    steps:
      - task: AzureCLI@2
        displayName: 'Build Bicep file(s)'
        inputs:
          azureSubscription: '${{ parameters.azureServiceConnection }}'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          addSpnToEnvironment: true
          inlineScript: |
            Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
            Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

            Set-AzDevOpsVariable -Name 'Arcus.Testing.TenantId' -Value $env:tenantId
            Set-AzDevOpsVariable -Name 'Arcus.Testing.ServicePrincipal.ClientId' -Value $env:servicePrincipalId
            Set-AzDevOpsVariable -Name 'Arcus.Testing.ServicePrincipal.ClientSecret' -Value $env:servicePrincipalKey -AsSecret

      - task: AzureCLI@2
        displayName: Analyze PSRule
        inputs:
          azureSubscription: '${{ parameters.azureServiceConnection }}'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          addSpnToEnvironment: true
          inlineScript: |
            $clientSecret = ConvertTo-SecureString $env:servicePrincipalKey -AsPlainText -Force
            $pscredential = New-Object -TypeName System.Management.Automation.PSCredential($env:servicePrincipalId, $clientSecret)
            Disable-AzContextAutosave -Scope Process
            Connect-AzAccount -Credential $pscredential -TenantId $env:tenantId -ServicePrincipal
            
            Export-AzRuleData -OutputPath 'out/templates/'
            Assert-PSRule -Module 'PSRule.Rules.Azure' -InputPath 'out/templates/'

      - task: AzureCLI@2
        displayName: Analyze Azure policies
        inputs:
          azureSubscription: '${{ parameters.azureServiceConnection }}'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          addSpnToEnvironment: true
          inlineScript: |
            Install-Module -Name Pester -Force -SkipPublisherCheck
            Invoke-Pester -Script "./build/templates/policy-tests.ps1" -OutputFile "./pester.test.results.xml" -OutputFormat 'NUnitXML' -EnableExit

      - task: PublishTestResults@2
        displayName: 'Publish test results'
        condition: always()
        inputs:
          testResultsFormat: 'NUnit'
          testResultsFiles: '**/pester.test.results.xml'
          failTaskOnFailedTests: true